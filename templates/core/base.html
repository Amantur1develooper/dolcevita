{% load static %}
{% load i18n %}
{% load i18n i18n_attrs %}
{% get_current_language as LANGUAGE_CODE %}
<!doctype html>
<html lang="{{ LANGUAGE_CODE|default:'ru' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>{% block title %}{% trans "Dolce Vita Family — italian restaurant" %}{% endblock %}</title>
  <meta name="description" content="{% block meta_description %}{% trans "Аутентичная итальянская кухня: пицца из печи, паста, салаты. Быстрый заказ в WhatsApp." %}{% endblock %}">
  <meta name="theme-color" content="#128148">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'logo2.jpg' %}">
  <link rel="icon" type="image/png" sizes="16x16" href="{% static 'logo2.jpg' %}">
  <link rel="apple-touch-icon" href="{% static 'logo2.jpg' %}">
  <link rel="shortcut icon" href="{% static 'hat.jpg' %}">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{ --green:#009246; --white:#ffffff; --red:#ce2b37; --ink:#1f1f1f; --paper:#f5f3ef; }
  html,body{ height:100%; color:var(--ink); }

  /* Базовый фон + лёгкая «вуаль» для читабельности текста */
  body{
    background:none;
      
      {% comment %} url("{% static 'fon2.jpeg' %}") center / cover no-repeat fixed; {% endcomment %}
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
.page-bg{
  position: fixed;
  inset: 0;               /* top:0; right:0; bottom:0; left:0 */
  z-index: -1;            /* под всем контентом */
  background: url("{% static 'fon2.jpeg' %}") center / cover no-repeat;
  pointer-events: none;   /* чтобы не перехватывал клики */
  will-change: transform; /* сглаживает подёргивания */
  transform: translateZ(0);
}

/* На мобилках оставляем тот же фиксированный слой —
   он работает стабильнее, чем background-attachment: fixed у body */
@media (max-width: 768px){
  .page-bg{
    background-position: center top; /* при желании фиксируем компоновку */
  }
}

  /* На телефонах отключаем fixed — это главное */
  @media (max-width: 768px){
    body{
      background:none;
        
        {% comment %} url("{% static 'fon2.jpeg' %}") center top / cover no-repeat; /* без fixed */ {% endcomment %}
      /* Иногда помогает явно указать размер: */
      background-attachment: scroll;
    }
  }
    .brand{ font-family:"Cormorant Garamond", serif; letter-spacing:.02em; }
    .flag-x{ background:linear-gradient(90deg, var(--green) 0 33%, var(--white) 33% 66%, var(--red) 66% 100%); }
    .flag-y{ background:linear-gradient(180deg, var(--green) 0 33%, var(--white) 33% 66%, var(--red) 66% 100%); }
    a,button{ -webkit-tap-highlight-color: transparent; }
  </style>

  {% block head_extra %}{% endblock %}
</head>
<body>
<div class="page-bg" aria-hidden="true"></div>

<!-- HEADER -->
<header class="sticky top-0 z-50 bg-white/100 backdrop-blur border-b border-black/5">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <a href="{% url 'core:home' %}" class="flex items-center gap-3" aria-label="{% trans 'На главную' %}">
      <div class="brand text-2xl sm:text-3xl font-semibold italic" >
        <img style="height: 100px;" src="{% static 'logo2.jpg' %}" alt="">
       
      </div>
    </a>

    <!-- Desktop nav -->
    <nav class="hidden md:flex items-center gap-5 text-sm text-stone-700" aria-label="{% trans 'Основное меню' %}">
      <a href="{% url 'core:menu1' %}" class="hover:text-black">{% trans "Меню" %}</a>
      <a href="{% url 'core:home' %}" class="hover:text-black">{% trans "Доставка" %}</a>
      <a href="{% url 'core:contacts' %}" class="hover:text-black">{% trans "Контакты" %}</a>
      <a href="{% url 'core:reserve' %}" class="hover:text-black">{% trans "Бронирование" %}</a>
      <a href="{% url 'core:about' %}" class="hover:text-black">{% trans "О нас" %}</a>

    </nav>

    <div class="flex items-center gap-2">
      <!-- Burger (mobile only) -->
   

      <!-- Language switch -->
      <form action="{% url 'set_language' %}" method="post" class="flex items-center gap-2" aria-label="{% trans 'Выбор языка' %}">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path|default:'/' }}">
        <select name="language" class="border rounded-lg px-2 py-1 text-sm" onchange="this.form.submit()">
          <option value="ky" {% if LANGUAGE_CODE == 'ky' %}selected{% endif %}>Кыргызча</option>
          <option value="ru" {% if LANGUAGE_CODE == 'ru' %}selected{% endif %}>Русский</option>
          <option value="en" {% if LANGUAGE_CODE == 'en' %}selected{% endif %}>English</option>
        </select>
      </form>
   <button id="nav-toggle"
              class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border border-stone-300"
              aria-controls="mobile-menu" aria-expanded="false">
        <span class="sr-only">{% trans "Открыть меню" %}</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
      <!-- Cart -->
      <a href="{% url 'core:cart_detail' %}"
         class="relative inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-emerald-600 text-white font-semibold shadow"
         style="background:#25D366" aria-label="{% trans 'Перейти в корзину' %}">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2Zm10 0c-1.1 0-1.99.9-1.99 2S15.9 22 17 22s2-.9 2-2-.9-2-2-2ZM7.17 14h9.66c.75 0 1.41-.41 1.75-1.03l3.58-6.49A1 1 0 0 0 21.33 5H6.21L5.27 3H2v2h2l3.6 7.59-1.35 2.45C5.52 15.37 6.02 16 6.7 16H20v-2H7.42l.75-1.35Z"/>
        </svg>
        {% if cart_count %}
          <span id="cart-badge" class="absolute -top-2 -right-2 text-xs bg-red-600 text-white rounded-full px-1.5 py-0.5">{{ cart_count }}</span>
        {% else %}
          <span id="cart-badge" class="hidden absolute -top-2 -right-2 text-xs bg-red-600 text-white rounded-full px-1.5 py-0.5">0</span>
        {% endif %}
        <span class="hidden sm:inline">{% trans "Корзина" %}</span>
      </a>
    </div>
  </div>
  

  <!-- Mobile menu -->
  <div id="mobile-menu" class="md:hidden hidden border-t border-black/5 bg-white/95 backdrop-blur" role="region" aria-label="{% trans 'Мобильное меню' %}">
    <div class="max-w-6xl mx-auto px-4 py-3 grid grid-cols-1 gap-2 text-stone-800">
      <a class="px-3 py-2 rounded-lg hover:bg-stone-100" href="{% url 'core:home' %}">{% trans "Доставка" %}</a>
      <a href="{% url 'core:menu1' %}" class="px-3 py-2 rounded-lg hover:bg-stone-100">{% trans "Меню" %}</a>
      <a class="px-3 py-2 rounded-lg hover:bg-stone-100" href="{% url 'core:contacts' %}">{% trans "Контакты" %}</a>
      <a class="px-3 py-2 rounded-lg hover:bg-stone-100" href="{% url 'core:reserve' %}">{% trans "Бронирование" %}</a>
      <a class="px-3 py-2 rounded-lg hover:bg-stone-100" href="{% url 'core:about' %}">{% trans "О нас" %}</a>
      
      {% comment %} <a href="" class="hover:text-black"></a> {% endcomment %}

    </div>
  </div>
</header>

<!-- HERO (overrideable) -->


<!-- MAIN -->
<main class="max-w-6xl mx-auto px-4 py-6 pb-24 md:pb-6">
  {% block content %}{% endblock %}
</main>

{% block votchap %}
<!-- Floating WhatsApp CTA -->
<a href="{% url 'core:cart_detail' %}"
   class="fixed right-4 bottom-3 z-50 inline-flex items-center gap-2 px-4 py-3 rounded-full text-white font-semibold shadow-xl"
   style="background:#25D366"
   aria-label="{% trans 'Оформить заказ в WhatsApp' %}">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 32 32" fill="currentColor" aria-hidden="true">
    <path d="M19.11 17.34c-.28-.14-1.62-.8-1.87-.9-.25-.09-.43-.14-.61.14-.18.27-.7.9-.86 1.08-.16.18-.32.2-.6.07-.28-.14-1.19-.44-2.27-1.4-.84-.75-1.41-1.68-1.57-1.96-.16-.27-.02-.42.12-.56.12-.12.28-.32.42-.48.14-.16.18-.27.28-.45.09-.18.05-.34-.02-.48-.07-.14-.61-1.46-.83-2-.22-.53-.44-.46-.61-.47-.16-.01-.34-.01-.52-.01-.18 0-.48.07-.73.34-.25.27-.96.94-.96 2.28 0 1.34.99 2.63 1.13 2.8.14.18 1.95 2.98 4.72 4.18.66.28 1.18.45 1.58.57.66.21 1.26.18 1.73.11.53-.08 1.62-.66 1.85-1.3.23-.64.23-1.2.16-1.31-.07-.11-.25-.18-.53-.32z"/>
    <path d="M26.66 5.34C23.79 2.48 20.03 1 16 1 7.72 1 1 7.72 1 16c0 2.64.69 5.22 2 7.49L1 31l7.69-1.97A14.87 14.87 0 0 0 16 31c8.28 0 15-6.72 15-15 0-4.03-1.48-7.79-4.34-10.66zM16 28.33c-2.47 0-4.88-.66-6.98-1.92l-.5-.3-4.56 1.17 1.22-4.45-.33-.52A12.29 12.29 0 0 1 3.67 16c0-6.81 5.52-12.33 12.33-12.33 3.29 0 6.38 1.28 8.71 3.61a12.24 12.24 0 0 1 3.62 8.72c0 6.81-5.53 12.33-12.33 12.33z"/>
  </svg>
  {% trans "Заказать в WhatsApp" %}
</a>
{% endblock votchap %}

<!-- FOOTER -->
<footer class="mt-10 border-t border-black/5 bg-white/70 backdrop-blur">
  <div class="flag-x h-1 w-full"></div>
  <div class="max-w-6xl mx-auto px-4 py-6 text-sm text-stone-600">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
      <div>© Dolce Vita Family, {% now "Y" %}</div>
      <div class="text-stone-500">{% trans "Пицца из печи · Паста · Десерты" %}</div>
    </div>
  </div>
</footer>

<div id="toast" class="hidden fixed left-1/2 -translate-x-1/2 bottom-24 z-50">
  <div class="bg-black text-white px-4 py-2 rounded-full shadow-xl">{% trans "Добавлено в корзину" %}</div>
</div>

{% block scripts %}
<script>
  // Burger
  (function(){
    const btn = document.getElementById('nav-toggle');
    const menu = document.getElementById('mobile-menu');
    if (btn && menu) {
      btn.addEventListener('click', ()=>{
        const hidden = menu.classList.toggle('hidden');
        btn.setAttribute('aria-expanded', String(!hidden));
      });
      menu.querySelectorAll('a').forEach(a => a.addEventListener('click', ()=>{
        menu.classList.add('hidden');
        btn.setAttribute('aria-expanded','false');
      }));
    }
  })();

  // Sync cart badge (top -> floating if you add bottom badge later)
  (function(){
    const topBadge = document.getElementById('cart-badge');
    const bottomBadge = document.getElementById('cart-badge-bottom');
    function syncBadges() {
      if (!topBadge || !bottomBadge) return;
      const v = (topBadge.textContent || '0').trim();
      if (parseInt(v, 10) > 0) {
        bottomBadge.textContent = v;
        bottomBadge.classList.remove('hidden');
      } else {
        bottomBadge.classList.add('hidden');
      }
    }
    document.addEventListener('cart:updated', syncBadges);
    document.dispatchEvent(new Event('cart:updated'));
  })();

  // AJAX add-to-cart delegate (forms with data-add-to-cart)
  document.addEventListener('submit', async (e) => {
    const f = e.target;
    if (!f.matches('form[data-add-to-cart]')) return;

    e.preventDefault();

    const csrf = f.querySelector('input[name=csrfmiddlewaretoken]')?.value || '';
    const res = await fetch(f.action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrf,
      },
      body: new FormData(f),
    });

    if (!res.ok) {
      f.submit(); // graceful fallback
      return;
    }

    const data = await res.json();
    const badge = document.getElementById('cart-badge');
    if (badge) {
      badge.textContent = data.count ?? data.items_count ?? '0';
      badge.classList.remove('hidden');
    }

    const t = document.getElementById('toast');
    if (t) {
      t.classList.remove('hidden');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>t.classList.add('hidden'), 1400);
    }

    document.dispatchEvent(new Event('cart:updated'));
  });
</script>
{% endblock %}
</body>
</html>
